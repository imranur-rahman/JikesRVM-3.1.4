<?xml version="1.0" encoding="utf8" ?> 
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">  
<!--http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd-->  
<html xmlns="http://www.w3.org/1999/xhtml"  
> 
<head><title>7 Modifying Jikes RVM</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf8" /> 
<meta name="generator" content="TeX4ht (http://www.tug.org/tex4ht/)" /> 
<meta name="originator" content="TeX4ht (http://www.tug.org/tex4ht/)" /> 
<!-- xhtml,charset=utf8,2,html --> 
<meta name="src" content="userguide.tex" /> 
<meta name="date" content="2016-02-18 10:15:00" /> 
<link rel="stylesheet" type="text/css" href="userguide.css" /> 
</head><body 
>
<!--l. 2--><div class="crosslinks"><p class="noindent"></p></div>
<h2 class="chapterHead"><span class="titlemark">Chapter 7</span><br /><a 
 id="x9-710007"></a>Modifying Jikes RVM</h2>
<!--l. 5--><p class="noindent" >The sections <a 
href="#x9-880007.4">Coding Style</a> and <a 
href="#x9-830007.3">Coding Conventions</a> give a rough overview on existing
coding conventions.
</p><!--l. 7--><p class="noindent" >Jikes RVM is a bleeding-edge research project. You will ﬁnd that some of the code
does not live up to product quality standards. Don&#x2019;t hesitate to <a 
href="http://www.jikesrvm.org/HowToHelp/" >help rectify this</a> by
contributing clean-ups, refactorings, bug ﬁxes, tests and missing documentation to
the project.
</p>
<h3 class="sectionHead"><span class="titlemark">7.1   </span> <a 
 id="x9-720007.1"></a>Adding command line options</h3>
<!--l. 5--><p class="noindent" >There are several places in Jikes RVM where options can be deﬁned and each of those
uses another approach. There are options for </p>
     <ul class="itemize1">
     <li class="itemize">MMTk
     </li>
     <li class="itemize">VM subystems such as the compilers and the AOS
     </li>
     <li class="itemize">the core VM</li></ul>
<!--l. 12--><p class="noindent" >
</p>
<h4 class="subsectionHead"><span class="titlemark">7.1.1   </span> <a 
 id="x9-730007.1.1"></a>MMTk options</h4>
<!--l. 14--><p class="noindent" >Options that are relevant for MMTk can be found in the package
<span 
class="cmtt-10">org.mmtk.utility.options</span>. The only exception are options that must be parsed
before the VM can actually start (e.g. <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">-Xms</span></span></span> and <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">-Xmx</span></span></span>). Those options are classiﬁed as
core VM options.
</p><!--l. 16--><p class="noindent" >To create a new MMTk option, create a new class in the <span 
class="cmtt-10">org.mmtk.utility.options</span>
package, e.g. <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">YourOption</span></span></span>. The class must extend a class from the package
<span 
class="cmtt-10">org.vmutil.options</span>. Depending on the type of option, you may want to implement
the <span 
class="cmtt-10">validate </span>method.
</p>
<!--l. 18-->
<br />
    <div class="caption" 
><span class="id">6cAp0x9-730007.1.1:
    </span><span  
class="content">YourOption.java</span></div><!--tex4ht:label?: x9-730007.1 --><div class="lstlisting" id="listing-47"><span class="label"><a 
 id="x9-73001r1"></a></span><span 
class="cmti-10">/</span><span 
class="tcti-1000">*</span><span 
class="tcti-1000">*</span><span 
class="cmti-10"> </span><span 
class="cmti-10">Your</span><span 
class="cmti-10"> </span><span 
class="cmti-10">JavaDoc</span><span 
class="cmti-10"> </span><span 
class="tcti-1000">*</span><span 
class="cmti-10">/</span> <br /><span class="label"><a 
 id="x9-73002r2"></a></span><span 
class="cmbx-10">public</span> <span 
class="cmbx-10">class</span> YourOption <span 
class="cmbx-10">extends</span> org.vmutil.options.IntOption <span 
class="cmsy-10">{</span> <br /><span class="label"><a 
 id="x9-73003r3"></a></span> <br /><span class="label"><a 
 id="x9-73004r4"></a></span>  <span 
class="cmbx-10">private</span> <span 
class="cmbx-10">static</span> <span 
class="cmbx-10">final</span> <span 
class="cmbx-10">int</span> DEFAULT_VALUE = 42; <br /><span class="label"><a 
 id="x9-73005r5"></a></span> <br /><span class="label"><a 
 id="x9-73006r6"></a></span>  <span 
class="cmbx-10">public</span> YourOption() <span 
class="cmsy-10">{</span> <br /><span class="label"><a 
 id="x9-73007r7"></a></span>    <span 
class="cmbx-10">super</span>(Options.set, ”The_name_of_your_option”, <br /><span class="label"><a 
 id="x9-73008r8"></a></span>        ”The_description_of_your_option”, DEFAULT_VALUE); <br /><span class="label"><a 
 id="x9-73009r9"></a></span>  <span 
class="cmsy-10">}</span> <br /><span class="label"><a 
 id="x9-73010r10"></a></span> <br /><span class="label"><a 
 id="x9-73011r11"></a></span>  @Override <br /><span class="label"><a 
 id="x9-73012r12"></a></span>  <span 
class="cmbx-10">protected</span> <span 
class="cmbx-10">void</span> validate() <span 
class="cmsy-10">{</span> <br /><span class="label"><a 
 id="x9-73013r13"></a></span>    failIf(value <span 
class="cmmi-10">&#x003C;</span> 0 <span 
class="cmsy-10">||</span> value <span 
class="cmmi-10">&#x003E;</span> 55, <br /><span class="label"><a 
 id="x9-73014r14"></a></span>        ”Value_for_your_option_must_be_non-negative_and_55_or_smaller”); <br /><span class="label"><a 
 id="x9-73015r15"></a></span>  <span 
class="cmsy-10">}</span> <br /><span class="label"><a 
 id="x9-73016r16"></a></span><span 
class="cmsy-10">}</span>
</div>
<!--l. 37--><p class="noindent" >The newly created option must be linked to the rest of the system. In <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">Options</span></span></span> from
the package <span 
class="cmtt-10">org.mmtk.utility.options</span>, add a static variable for the option:
</p><!--l. 38-->
                                                                  

                                                                  
<br />
    <div class="caption" 
><span class="id">6cAp1x9-730007.1.1:
    </span><span  
class="content">Options.java</span></div><!--tex4ht:label?: x9-730007.1 --><div class="lstlisting" id="listing-48"><span class="label"><a 
 id="x9-73017r1"></a></span><span 
class="cmbx-10">public</span> <span 
class="cmbx-10">static</span> YourOption yourOption;
</div>
<!--l. 42--><p class="noindent" >Lastly, you will need to create an instance of the option in an appropriate place:
</p><!--l. 43-->
<div class="lstlisting" id="listing-49"><span class="label"><a 
 id="x9-73018r1"></a></span>Options.yourOption = <span 
class="cmbx-10">new</span> YourOption();
</div>
<!--l. 46--><p class="noindent" >General options can be created in the constructor of <span 
class="cmtt-10">org.mmtk.plan.Plan</span>. If the
option is speciﬁc to a garbage collector, you can create it in one of the collector&#x2019;s
classes.
</p><!--l. 48--><p class="noindent" >The actual String for the option that will be used on the command line is not
determined by MMTk but computed by the VM (Jikes RVM in this case). To
look up the chosen key for the newly added option, rebuild Jikes RVM,
pass <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">-X:gc</span></span></span> and examine the output. The output displays a list of MMTk
options. This list should now include the newly-added option. To verify that
the default value is correctly set, use <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">-X:gc:printOptions</span></span></span> and check the
value.
</p><!--l. 52--><p class="noindent" >
</p>
<h4 class="subsectionHead"><span class="titlemark">7.1.2   </span> <a 
 id="x9-740007.1.2"></a>VM subsystem options</h4>
<!--l. 54--><p class="noindent" >Classes for handling VM subsystem options are generated during the build process.
The source ﬁles for the options are in <span 
class="cmtt-10">rvm/src-generated/options</span>. The generated
option classes are </p>
     <ul class="itemize1">
     <li class="itemize"><span 
class="cmtt-10">org.jikesrvm.Options </span>for VM options
     </li>
     <li class="itemize"><span 
class="cmtt-10">org.jikesrvm.adaptive.util.AOSExternalOptions </span>for AOS Options
     </li>
     <li class="itemize"><span 
class="cmtt-10">org.jikesrvm.compilers.baseline.BaselineOptions   </span>for    baseline
     compiler options
     </li>
     <li class="itemize"><span 
class="cmtt-10">org.jikesrvm.compilers.opt.OptOptions </span>for opt compiler options</li></ul>
<!--l. 62--><p class="noindent" >Each option class is generated from the matching template ﬁle (e.g.
<span 
class="cmtt-10">AOSOptions.template </span>for <span 
class="cmtt-10">AOSExternalOptions</span>) and its speciﬁc options (e.g.
<span 
class="cmtt-10">BooleanOptions.aos.dat </span>and <span 
class="cmtt-10">ValueOptions.aos.dat</span>). Additionally, the baseline
and opt compiler options also use the shared option ﬁles <span 
class="cmtt-10">SharedBooleanOptions.dat</span>
and <span 
class="cmtt-10">SharedValueOptions.dat</span>.
</p><!--l. 64--><p class="noindent" >The existing options and documentation in the ﬁles should be suﬃcient
to create new options. Please notify us if the documentation needs to be
improved.
                                                                  

                                                                  
</p><!--l. 68--><p class="noindent" >
</p>
<h4 class="subsectionHead"><span class="titlemark">7.1.3   </span> <a 
 id="x9-750007.1.3"></a>Core VM options</h4>
<!--l. 70--><p class="noindent" >Options for the core VM are not speciﬁc to a certain subsystem. These options are
recognized for all builds of Jikes RVM. This category includes </p>
     <ul class="itemize1">
     <li class="itemize">bootloader options (e.g. ﬁle names for code, data and reference maps of
     the VM)
     </li>
     <li class="itemize">options that must be processed without help of Java code (e.g. <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">Xms</span></span></span> for the
     initial heap size or <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">-Xbootclasspath/p:&#x003C;cp&#x003E;</span></span></span> for modiﬁcation of the boot
     classpath)
     </li>
     <li class="itemize">preﬁxes for option groups like <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">-X:opt</span></span></span> or <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">-X:gc</span></span></span></li></ul>
<!--l. 77--><p class="noindent" >Note that an option can be recognized without being available for use. For example,
attempting to use <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">-X:opt</span></span></span> to get help about the optimizing compiler options will fail
on builds that don&#x2019;t include the optimizing compiler.
</p><!--l. 79--><p class="noindent" >All Core VM options are parsed in the C code. Some are also processed in
Java code. If you want to add a core VM option, you will need to modify
the bootloader code in order to ensure that options are passed correctly.
Recall that the Jikes RVM command line help (<span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">-help</span></span></span>) says the following:
</p><!--l. 80-->
<div class="lstlisting" id="listing-50"><span class="label"><a 
 id="x9-75001r1"></a></span>Usage: JikesRVM [-options] class [args...] <br /><span class="label"><a 
 id="x9-75002r2"></a></span>          (to execute a class) <br /><span class="label"><a 
 id="x9-75003r3"></a></span>   or  JikesRVM [-options] -jar jarfile [args...] <br /><span class="label"><a 
 id="x9-75004r4"></a></span>          (to execute a jar file)
</div>
<!--l. 86--><p class="noindent" >The bootloader enforces this usage. It parses all options and if it encounters an
option that it doesn&#x2019;t recognize, it will assume that this option signiﬁes the
start of the application arguments. Consequently, it is necessary to tell the
bootloader about all core VM options. The relevant code fragment is shown
below.
</p>
<!--l. 88-->
<br />
    <div class="caption" 
><span class="id">6cAp2x9-750007.1.3:
    </span><span  
class="content">main.c</span></div><!--tex4ht:label?: x9-750007.1 --><div class="lstlisting" id="listing-51"><span class="label"><a 
 id="x9-75005r1"></a></span><span 
class="cmbx-10">#</span><span 
class="cmbx-10">define</span> BOOTCLASSPATH_A_INDEX         BOOTCLASSPATH_P_INDEX + 1 <br /><span class="label"><a 
 id="x9-75006r2"></a></span><span 
class="cmbx-10">#</span><span 
class="cmbx-10">define</span> PROCESSORS_INDEX              BOOTCLASSPATH_A_INDEX + 1 <br /><span class="label"><a 
 id="x9-75007r3"></a></span> <br /><span class="label"><a 
 id="x9-75008r4"></a></span><span 
class="cmbx-10">#</span><span 
class="cmbx-10">define</span> numNonstandardArgs      PROCESSORS_INDEX + 1 <br /><span class="label"><a 
 id="x9-75009r5"></a></span> <br /><span class="label"><a 
 id="x9-75010r6"></a></span><span 
class="cmbx-10">static</span> <span 
class="cmbx-10">const</span> <span 
class="cmbx-10">char</span><span 
class="tcrm-1000">*</span> nonStandardArgs[numNonstandardArgs] = <span 
class="cmsy-10">{</span> <br /><span class="label"><a 
 id="x9-75011r7"></a></span> ... more code here ... <br /><span class="label"><a 
 id="x9-75012r8"></a></span>  ”-X:availableProcessors=”, <br /><span class="label"><a 
 id="x9-75013r9"></a></span><span 
class="cmsy-10">}</span>;
</div>
<!--l. 100--><p class="noindent" >To add a new option, make the following modiﬁcations:
</p>
<!--l. 102-->
<br />
    <div class="caption" 
><span class="id">6cAp3x9-750007.1.3:
    </span><span  
class="content">main.c</span></div><!--tex4ht:label?: x9-750007.1 --><div class="lstlisting" id="listing-52"><span class="label"><a 
 id="x9-75014r1"></a></span><span 
class="cmbx-10">#</span><span 
class="cmbx-10">define</span> BOOTCLASSPATH_A_INDEX         BOOTCLASSPATH_P_INDEX + 1 <br /><span class="label"><a 
 id="x9-75015r2"></a></span><span 
class="cmbx-10">#</span><span 
class="cmbx-10">define</span> PROCESSORS_INDEX              BOOTCLASSPATH_A_INDEX + 1 <br /><span class="label"><a 
 id="x9-75016r3"></a></span><span 
class="cmbx-10">#</span><span 
class="cmbx-10">define</span> YOUR_OPTION_INDEX             PROCESSORS_INDEX + 1 <br /><span class="label"><a 
 id="x9-75017r4"></a></span> <br /><span class="label"><a 
 id="x9-75018r5"></a></span><span 
class="cmbx-10">#</span><span 
class="cmbx-10">define</span> numNonstandardArgs      YOUR_OPTION_INDEX + 1 <br /><span class="label"><a 
 id="x9-75019r6"></a></span> <br /><span class="label"><a 
 id="x9-75020r7"></a></span><span 
class="cmbx-10">static</span> <span 
class="cmbx-10">const</span> <span 
class="cmbx-10">char</span><span 
class="tcrm-1000">*</span> nonStandardArgs[numNonstandardArgs] = <span 
class="cmsy-10">{</span> <br /><span class="label"><a 
 id="x9-75021r8"></a></span> ... more code here ... <br /><span class="label"><a 
 id="x9-75022r9"></a></span>  ”-X:availableProcessors=”, <br /><span class="label"><a 
 id="x9-75023r10"></a></span>  ”-X:your_option=”, <br /><span class="label"><a 
 id="x9-75024r11"></a></span><span 
class="cmsy-10">}</span>;
                                                                  

                                                                  
</div>
<!--l. 116--><p class="noindent" >It is recommended that you also add a description of your option to the
<span 
class="cmtt-10">nonstandardusage </span>array.
</p><!--l. 118--><p class="noindent" >You must modify <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">processCommandLineArguments(..)</span></span></span> to recognize the option in
order to make sure that the option is properly handled and/or passed to the Java
code. Failing to do so will cause bugs like <a 
href="https://xtenlang.atlassian.net/browse/RVM-1066" >RVM-1066</a>. For example, if the option were
to take one token, the original code
</p>
<!--l. 120-->
<br />
        <div class="caption" 
><span class="id">6cAp4x9-750007.1.3:
        </span><span  
class="content">main.c</span></div><!--tex4ht:label?: x9-750007.1 --><div class="lstlisting" id="listing-53"><span class="label"><a 
 id="x9-75025r1"></a></span><span 
class="cmti-10">//</span><span 
class="cmti-10"> </span><span 
class="cmti-10">All</span><span 
class="cmti-10"> </span><span 
class="cmti-10">VM</span><span 
class="cmti-10"> </span><span 
class="cmti-10">directives</span><span 
class="cmti-10"> </span><span 
class="cmti-10">that</span><span 
class="cmti-10"> </span><span 
class="cmti-10">take</span><span 
class="cmti-10"> </span><span 
class="cmti-10">one</span><span 
class="cmti-10"> </span><span 
class="cmti-10">token</span> <br /><span class="label"><a 
 id="x9-75026r2"></a></span><span 
class="cmbx-10">if</span> (STRNEQUAL(token, ”-D”, 2) <br /><span class="label"><a 
 id="x9-75027r3"></a></span>        <span 
class="cmsy-10">||</span> STRNEQUAL(token, nonStandardArgs[INDEX], 5) <br /><span class="label"><a 
 id="x9-75028r4"></a></span>... more code here ... <br /><span class="label"><a 
 id="x9-75029r5"></a></span>        <span 
class="cmsy-10">||</span> STRNEQUAL(token, nonStandardArgs[BOOTCLASSPATH_P_INDEX], 18) <br /><span class="label"><a 
 id="x9-75030r6"></a></span>        <span 
class="cmsy-10">||</span> STRNEQUAL(token, nonStandardArgs[BOOTCLASSPATH_A_INDEX], 18) <br /><span class="label"><a 
 id="x9-75031r7"></a></span>        <span 
class="cmsy-10">||</span> STRNEQUAL(token, nonStandardArgs[PROCESSORS_INDEX], 14)) <br /><span class="label"><a 
 id="x9-75032r8"></a></span>    <span 
class="cmsy-10">{</span> <br /><span class="label"><a 
 id="x9-75033r9"></a></span>      CLAs[n_JCLAs++]=token; <br /><span class="label"><a 
 id="x9-75034r10"></a></span>      <span 
class="cmbx-10">continue</span>; <br /><span class="label"><a 
 id="x9-75035r11"></a></span>    <span 
class="cmsy-10">}</span>
</div>
<!--l. 134--><p class="noindent" >would need to be changed to </p><!--l. 135-->
<br />
        <div class="caption" 
><span class="id">6cAp5x9-750007.1.3:
        </span><span  
class="content">main.c</span></div><!--tex4ht:label?: x9-750007.1 --><div class="lstlisting" id="listing-54"><span class="label"><a 
 id="x9-75036r1"></a></span><span 
class="cmbx-10">if</span> (STRNEQUAL(token, ”-D”, 2) <br /><span class="label"><a 
 id="x9-75037r2"></a></span>        <span 
class="cmsy-10">||</span> STRNEQUAL(token, nonStandardArgs[INDEX], 5) <br /><span class="label"><a 
 id="x9-75038r3"></a></span>... more code here ... <br /><span class="label"><a 
 id="x9-75039r4"></a></span>        <span 
class="cmsy-10">||</span> STRNEQUAL(token, nonStandardArgs[BOOTCLASSPATH_P_INDEX], 18) <br /><span class="label"><a 
 id="x9-75040r5"></a></span>        <span 
class="cmsy-10">||</span> STRNEQUAL(token, nonStandardArgs[BOOTCLASSPATH_A_INDEX], 18) <br /><span class="label"><a 
 id="x9-75041r6"></a></span>        <span 
class="cmsy-10">||</span> STRNEQUAL(token, nonStandardArgs[PROCESSORS_INDEX], 14) <br /><span class="label"><a 
 id="x9-75042r7"></a></span>        <span 
class="cmsy-10">||</span> STRNEQUAL(token, nonStandardArgs[YOUR_OPTION_INDEX], <span 
class="tcrm-1000">$</span>LENGTH)) <br /><span class="label"><a 
 id="x9-75043r8"></a></span>    <span 
class="cmsy-10">{</span> <br /><span class="label"><a 
 id="x9-75044r9"></a></span>      CLAs[n_JCLAs++]=token; <br /><span class="label"><a 
 id="x9-75045r10"></a></span>      <span 
class="cmbx-10">continue</span>; <br /><span class="label"><a 
 id="x9-75046r11"></a></span>    <span 
class="cmsy-10">}</span>
</div>
<!--l. 148--><p class="noindent" >where <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">$LENGTH</span></span></span> is the length of the string for your option that you added to the
<span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">nonStandardArgs</span></span></span> array.
</p><!--l. 150--><p class="noindent" >The above steps are suﬃcient for options that only need processing in bootloader code.
If your option needs processing in Java, you will need to modify <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">CommandLineArgs</span></span></span>.
Firstly, add a new constant for your option to <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">PrefixType</span></span></span>. For example, the code
</p><!--l. 151-->
<br />
    <div class="caption" 
><span class="id">6cAp6x9-750007.1.3:
    </span><span  
class="content">CommandLineArgs.java</span></div><!--tex4ht:label?: x9-750007.1 --><div class="lstlisting" id="listing-55"><span class="label"><a 
 id="x9-75047r1"></a></span>    BOOTCLASSPATH_A_ARG, <br /><span class="label"><a 
 id="x9-75048r2"></a></span>    BOOTSTRAP_CLASSES_ARG, <br /><span class="label"><a 
 id="x9-75049r3"></a></span>    AVAILABLE_PROCESSORS_ARG <br /><span class="label"><a 
 id="x9-75050r4"></a></span><span 
class="cmsy-10">}</span>
</div>
<!--l. 158--><p class="noindent" >would need to be changed to
</p>
<!--l. 160-->
<br />
    <div class="caption" 
><span class="id">6cAp7x9-750007.1.3:
    </span><span  
class="content">CommandLineArgs.java</span></div><!--tex4ht:label?: x9-750007.1 --><div class="lstlisting" id="listing-56"><span class="label"><a 
 id="x9-75051r1"></a></span>    BOOTCLASSPATH_A_ARG, <br /><span class="label"><a 
 id="x9-75052r2"></a></span>    BOOTSTRAP_CLASSES_ARG, <br /><span class="label"><a 
 id="x9-75053r3"></a></span>    AVAILABLE_PROCESSORS_ARG, <br /><span class="label"><a 
 id="x9-75054r4"></a></span>    YOUR_OPTION_ARG <br /><span class="label"><a 
 id="x9-75055r5"></a></span><span 
class="cmsy-10">}</span>
</div>
<!--l. 168--><p class="noindent" >Secondly, you will need to create a new <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">Prefix</span></span></span> instance in the <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">prefixes</span></span></span> array. After
that, you&#x2019;re ready to add the processing of your option.
</p><!--l. 2--><p class="noindent" >
</p>
                                                                  

                                                                  
<h3 class="sectionHead"><span class="titlemark">7.2   </span> <a 
 id="x9-760007.2"></a>Adding a new garbage collector</h3>
<!--l. 6--><p class="noindent" >
</p>
<h4 class="subsectionHead"><span class="titlemark">7.2.1   </span> <a 
 id="x9-770007.2.1"></a>Overview</h4>
<!--l. 8--><p class="noindent" >This document describes how to add a new garbage collector to Jikes RVM. We don&#x2019;t
address how to design a new GC algorithm, just how to add a ”new” GC to the
system and then build it. We do this by cloning an existing GC. We leave it to you to
design your own GC!
</p><!--l. 12--><p class="noindent" >
</p>
<h4 class="subsectionHead"><span class="titlemark">7.2.2   </span> <a 
 id="x9-780007.2.2"></a>Prerequisites</h4>
<!--l. 14--><p class="noindent" >Ensure that you have got a clean copy of the source (either a recent release or the git
HEAD) and can correctly and successfully build one of the base garbage collectors.
There&#x2019;s little point in trying to build your own until you can reliably build an
existing one. I suggest you start with MarkSweep, and that you use the <a 
href="BuildingJikesRVM.html#x5-340003.8">buildit</a>
script:
</p>
<!--l. 16-->
<div class="lstlisting" id="listing-57"><span class="label"><a 
 id="x9-78001r1"></a></span><span 
class="tcrm-1000">$</span> bin/buildit <span 
class="cmmi-10">&#x003C;</span>targetmachine<span 
class="cmmi-10">&#x003E;</span> BaseBase MarkSweep
</div>
<!--l. 20--><p class="noindent" >Then test your GC:
</p>
<!--l. 22-->
<div class="lstlisting" id="listing-58"><span class="label"><a 
 id="x9-78002r1"></a></span><span 
class="tcrm-1000">$</span> bin/buildit <span 
class="cmmi-10">&#x003C;</span>targetmachine<span 
class="cmmi-10">&#x003E;</span> -t gctest BaseBase MarkSweep
</div>
<!--l. 26--><p class="noindent" >You should have seen some output like this:
</p>
<!--l. 28-->
<div class="lstlisting" id="listing-59"><span class="label"><a 
 id="x9-78003r1"></a></span>test: <br /><span class="label"><a 
 id="x9-78004r2"></a></span>     [echo] Test Result for [BaseBaseMarkSweep<span 
class="cmsy-10">|</span>gctest] InlineAllocation (default) : SUCCESS <br /><span class="label"><a 
 id="x9-78005r3"></a></span>     [echo] Test Result for [BaseBaseMarkSweep<span 
class="cmsy-10">|</span>gctest] ReferenceTest (default) : SUCCESS <br /><span class="label"><a 
 id="x9-78006r4"></a></span>     [echo] Test Result for [BaseBaseMarkSweep<span 
class="cmsy-10">|</span>gctest] ReferenceStress (default) : SUCCESS <br /><span class="label"><a 
 id="x9-78007r5"></a></span>     [echo] Test Result for [BaseBaseMarkSweep<span 
class="cmsy-10">|</span>gctest] FixedLive (default) : SUCCESS <br /><span class="label"><a 
 id="x9-78008r6"></a></span>     [echo] Test Result for [BaseBaseMarkSweep<span 
class="cmsy-10">|</span>gctest] LargeAlloc (default) : SUCCESS <br /><span class="label"><a 
 id="x9-78009r7"></a></span>     [echo] Test Result for [BaseBaseMarkSweep<span 
class="cmsy-10">|</span>gctest] Exhaust (default) : SUCCESS
</div>
<!--l. 38--><p class="noindent" >If this is not working, you should probably go and (re) read the section in the user
guide on <a 
href="userguidepa1.html#x2-1000I">how to build and run</a> the VM.
</p><!--l. 42--><p class="noindent" >
</p>
<h4 class="subsectionHead"><span class="titlemark">7.2.3   </span> <a 
 id="x9-790007.2.3"></a>Cloning the MarkSweep GC</h4>
<!--l. 44--><p class="noindent" >The best way to do this is in eclipse or a similar tool (see here for how to work with
eclipse):
                                                                  

                                                                  
     </p><ol  class="enumerate1" >
     <li 
  class="enumerate" id="x9-79002x1">Clone the <span 
class="cmti-10">org.mmtk.plan.marksweep as org.mmtk.plan.</span><span 
class="cmbxti-10">mygc</span>
         <ol  class="enumerate2" >
         <li 
  class="enumerate" id="x9-79004x1">You can do this with Eclipse:
             <ol  class="enumerate3" >
             <li 
  class="enumerate" id="x9-79006x1">Navigate to org.mmtk.plan.marksweep (within MMTk/src)
             </li>
             <li 
  class="enumerate" id="x9-79008x2">Right click over org.mmtk.plan.marksweep and select ”Copy”
             </li>
             <li 
  class="enumerate" id="x9-79010x3">Right click again, and select ”Paste”, and name the target <br 
class="newline" />org.mmtk.plan.mygc (or whatever you like)
             </li>
             <li 
  class="enumerate" id="x9-79012x4">This will have cloned the marksweep GC in a new package called
             org.mmtk.plan.mygc</li></ol>
         </li>
         <li 
  class="enumerate" id="x9-79014x2">or by hand:
             <ol  class="enumerate3" >
             <li 
  class="enumerate" id="x9-79016x1">Copy the directory MMTk/org/mmtk/plan/marksweep to <br 
class="newline" />MMTk/org/mmtk/plan/mygc
             </li>
             <li 
  class="enumerate" id="x9-79018x2">Edit each ﬁle within MMTk/org/mmtk/plan/mygc and change
             its package declaration to org.mmtk.plan.mygc</li></ol>
         </li>
         <li 
  class="enumerate" id="x9-79020x3">We can leave the GC called ”MS” for now (the ﬁle names will all be
         MMTk/org/mmtk/plan/mygc/MS*.java)</li></ol>
     </li>
     <li 
  class="enumerate" id="x9-79022x2">Clone the BaseBaseMarkSweep.properties ﬁle as BaseBaseMyGC.properties:
         <ol  class="enumerate2" >
         <li 
  class="enumerate" id="x9-79024x1">Go       to       build/conﬁgs,       and       right       click       over
         BaseBaseMarkSweep.properties, and select ”Copy”
         </li>
         <li 
  class="enumerate" id="x9-79026x2">Right      click      and      select      ”Paste”,      and      paste      as
         BaseBaseMyGC.properties
         </li>
         <li 
  class="enumerate" id="x9-79028x3">Edit BaseBaseMyGC.properties, changing the text: <!--l. 67-->
         <div class="lstlisting" id="listing-60"><span class="label"><a 
 id="x9-79029r1"></a></span>config.mmtk.plan=org.mmtk.plan.marksweep.MS
         
         </div>
         <!--l. 70--><p class="noindent" >to </p><!--l. 71-->
         <div class="lstlisting" id="listing-61"><span class="label"><a 
 id="x9-79030r1"></a></span>config.mmtk.plan=org.mmtk.plan.mygc.MS
         
         </div>
         </li></ol>
                                                                  

                                                                  
     </li>
     <li 
  class="enumerate" id="x9-79032x3">Now test your new GC:</li></ol>
<!--l. 77-->
<div class="lstlisting" id="listing-62"><span class="label"><a 
 id="x9-79033r1"></a></span><span 
class="tcrm-1000">$</span> bin/buildit <span 
class="cmmi-10">&#x003C;</span>targetmachine<span 
class="cmmi-10">&#x003E;</span> -t gctest BaseBase MyGC
</div>
<!--l. 82--><p class="noindent" >You should have got similar output to your test of MarkSweep above.
</p><!--l. 84--><p class="noindent" >That&#x2019;s it. You&#x2019;re done. <span 
class="wasy-10">☺</span>
</p><!--l. 88--><p class="noindent" >
</p>
<h4 class="subsectionHead"><span class="titlemark">7.2.4   </span> <a 
 id="x9-800007.2.4"></a>Making it Prettier</h4>
<!--l. 90--><p class="noindent" >You may have noticed that when you cloned the package <span 
class="cmti-10">org.mmtk.plan.marksweep</span>,
all the classes retained their old names (although in your new namespace;
<span 
class="cmti-10">org.mmtk.plan.</span><span 
class="cmbxti-10">mygc</span>). You can trivially change the class names in an IDE like
eclipse. You can do the same with your favorite text editor, but you&#x2019;ll need to be sure
that you change the references carefully. To change the class names in eclipse, just
follow the procedure below for each class in <span 
class="cmti-10">org.mmtk.plan.</span><span 
class="cmbxti-10">mygc</span>:
     </p><ol  class="enumerate1" >
     <li 
  class="enumerate" id="x9-80002x1">Navigate to the class you want changed (eg org.mmtk.plan.mygc.MS)
     </li>
     <li 
  class="enumerate" id="x9-80004x2">Right click on the class (MS) and select <span 
class="cmti-10">”Refactor</span><span 
class="tcti-1000">→</span><span 
class="cmti-10"> Rename...” </span>and then
     type in your new name, (eg <span 
class="cmti-10">MyGC</span>)
     </li>
     <li 
  class="enumerate" id="x9-80006x3">Do the same for each of the other classes:
         <ul class="itemize1">
         <li class="itemize">MS <span 
class="tcrm-1000">→</span> MyGC
         </li>
         <li class="itemize">MSCollector <span 
class="tcrm-1000">→</span> MyGCCollector
         </li>
         <li class="itemize">MSConstraints <span 
class="tcrm-1000">→</span> MyGCConstraints
         </li>
         <li class="itemize">MSMutator <span 
class="tcrm-1000">→</span> MyGCMutator
         </li>
         <li class="itemize">MSTraceLocal <span 
class="tcrm-1000">→</span> MyGCTraceLocal</li></ul>
     </li>
     <li 
  class="enumerate" id="x9-80008x4">Edit your conﬁguration/s to ensure they refer to the renamed classes (since
     your IDE is unlikely to have done this automatically for you)
         <ul class="itemize1">
         <li class="itemize">Go to <span 
class="cmti-10">build/conﬁgs</span>, and edit each ﬁle <span 
class="cmti-10">*MyGC.properties </span>to refer to
         your renamed classes</li></ul>
     </li></ol>
                                                                  

                                                                  
<!--l. 110--><p class="noindent" >
</p>
<h4 class="subsectionHead"><span class="titlemark">7.2.5   </span> <a 
 id="x9-810007.2.5"></a>Beyond BaseBaseMyGC</h4>
<!--l. 112--><p class="noindent" >You probably want to build with conﬁgurations other than just BaseBase. If so,
clone conﬁgurations from MarkSweep, just as you did above (for example,
clone <span 
class="cmti-10">FullAdaptiveMarkSweep </span>as <span 
class="cmti-10">FullAdaptive</span><span 
class="cmbxti-10">MyGC</span>). It&#x2019;s best to leave
the Fast conﬁgurations for last, when you&#x2019;re sure that your GC is working
correctly.
</p><!--l. 116--><p class="noindent" >
</p>
<h4 class="subsectionHead"><span class="titlemark">7.2.6   </span> <a 
 id="x9-820007.2.6"></a>What Next?</h4>
<!--l. 118--><p class="noindent" >Once you have this working, you have successfully created and tested your own GC
without writing a line of code! You are ready to start the slightly more tricky process
of writing your own garbage collector code.
</p><!--l. 120--><p class="noindent" >If you are writing a new GC, you should deﬁnitely be aware of the <a 
href="TheMMTkTestHarness.html#x13-13600011">MMTk test
harness</a>, which allows you to test and debug MMTk in a very well contained pure
Java environment, without the rest of Jikes RVM. This allows you to write unit tests
and corner cases, and moreover, allows you to edit and debug MMTk entirely from
within your IDE.
</p><!--l. 2--><p class="noindent" >
</p>
<h3 class="sectionHead"><span class="titlemark">7.3   </span> <a 
 id="x9-830007.3"></a>Coding Conventions</h3>
<!--l. 5--><p class="noindent" >
</p>
<h4 class="subsectionHead"><span class="titlemark">7.3.1   </span> <a 
 id="x9-840007.3.1"></a>Assertions in Jikes RVM and MMTk</h4>
<!--l. 7--><p class="noindent" >Partly for historical reasons, we use our own built-in assertion facility rather than the
one that appeared in Sun®&#x2019;s JDK 1.4. All assertion checks have one of the two
forms:
</p>
<!--l. 9-->
<div class="lstlisting" id="listing-63"><span class="label"><a 
 id="x9-84001r1"></a></span><span 
class="cmbx-10">if</span> (VM.VerifyAssertions)  VM._assert(condition) <br /><span class="label"><a 
 id="x9-84002r2"></a></span><span 
class="cmbx-10">if</span> (VM.VerifyAssertions)  VM._assert(condition,  message)
</div>
<!--l. 14--><p class="noindent" ><span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">VM.VerifyAssertions</span></span></span> is a <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">public static final</span></span></span> ﬁeld. The <span 
class="cmtt-10">config.assertions</span>
conﬁguration variable determines <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">VM.VerifyAssertions</span></span></span>&#x2019; value. If <span 
class="cmtt-10">config.assertions</span>
is set to none, Jikes RVM has no assertion overhead.
</p><!--l. 16--><p class="noindent" >If you use the form without a message, then the default message ”vm internal error
at:” will appear.
</p><!--l. 18--><p class="noindent" >If you use the form with a message the message must be a single string literal. Doing
string appends in assertions can be a source of horrible performance problems when
assertions are enabled (i.e. most development builds). If you want to provide a more
                                                                  

                                                                  
detailed error message when the assertion fails, then you must use the following
coding pattern:
</p>
<!--l. 20-->
<div class="lstlisting" id="listing-64"><span class="label"><a 
 id="x9-84003r1"></a></span><span 
class="cmbx-10">if</span> (VM.VerifyAssertions &#x0026;&#x0026; condition) <span 
class="cmsy-10">{</span> <br /><span class="label"><a 
 id="x9-84004r2"></a></span>  ... build message ... <br /><span class="label"><a 
 id="x9-84005r3"></a></span>  VM._assert(VM.NOT_REACHED, message); <br /><span class="label"><a 
 id="x9-84006r4"></a></span><span 
class="cmsy-10">}</span>
</div>
<!--l. 27--><p class="noindent" >An assertion failure is always followed by a stack dump.
</p><!--l. 29--><p class="noindent" >Use <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">VM.ExtremeAssertions</span></span></span> instead of <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">VM.VerifyAssertions</span></span></span> if the assertion is
costly to check but generally useful. These kinds of assertions are only enabled when
<span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">config.assertions</span></span></span> is set to <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">extreme</span></span></span>.
</p><!--l. 31--><p class="noindent" >Use <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">IR.SANITY_CHECK</span></span></span> or <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">IR.PARANOID</span></span></span> to guard assertions that relate to the
intermediate representation in the optimizing compiler.
</p><!--l. 35--><p class="noindent" >
</p>
<h4 class="subsectionHead"><span class="titlemark">7.3.2   </span> <a 
 id="x9-850007.3.2"></a>Assertions in the MMTk Test Harness</h4>
<!--l. 37--><p class="noindent" >The assert keyword may be used in the MMTk Harness.
</p><!--l. 41--><p class="noindent" >
</p>
<h4 class="subsectionHead"><span class="titlemark">7.3.3   </span> <a 
 id="x9-860007.3.3"></a>Error Handling</h4>
<!--l. 43--><p class="noindent" >All code in the system needs to detect and handle errors. If you know that your code
does not handle certain situations, you should aim to write the code in way that
detects these situations. The code also needs to be documented well enough so that
users get a hint about the source of the problem. Keep in mind that the Jikes RVM is
also used by students who may not be as familiar with the domain as researchers
are.
</p><!--l. 45--><p class="noindent" >
</p>
<h5 class="subsubsectionHead"><a 
 id="x9-870007.3.3"></a>Examples</h5>
     <ul class="itemize1">
     <li class="itemize">The code does not work at all in a certain situation, e.g. it gives incorrect
     results when the optimizing compiler is enabled or a certain optimization
     is turned on. In this case, the best approach is to detect the situation and
     fail fast. This can be done using assertions. You can use VM.sysFail(..) for
     builds without assertions if correct execution after failure is impossible.
     </li>
     <li class="itemize">A  compiler  optimizations  fails.  The  correct  approach  is  to  throw
     an  OptimizingCompilerException  (e.g.  via  one  of  the  static  methods
     provided  by  that  class).  This  will  lead  to  a  hard  failure  when
     -X:vm:errorsFatal=true is set (which is the case in regression tests). In
                                                                  

                                                                  
     other cases, the VM will just revert to using the baseline compiler.
     </li>
     <li class="itemize">A command line option has a limited range of values. In MMTk, the
     correct approach is to implement the validate() method for the option.
     In other places, the value of the option needs to be checked at a suitable
     time.</li></ul>
<!--l. 2--><p class="noindent" >
</p>
<h3 class="sectionHead"><span class="titlemark">7.4   </span> <a 
 id="x9-880007.4"></a>Coding Style</h3>
<!--l. 5--><p class="noindent" >Regrettably, some code in the current system does not follow any consistent coding
style. This is an unfortunate residuum of the system&#x2019;s evolution.
</p><!--l. 7--><p class="noindent" >We use checkstyle to support a gradually expanding subset of coding
conventions. The current set of enforced checkstyle rules are deﬁned by
<span 
class="tctt-1000">$</span><span 
class="cmtt-10">RVM</span><span 
class="cmtt-10">_ROOT/build/checkstyle/rvm-checks.xml </span>and are veriﬁed as part of the
pre-commit test run. To check for violations of the coding style without
running the tests, <a 
href="BuildingJikesRVM.html#x5-340003.8">use buildit</a> or run ”ant checkstyle” from the command
line.
</p><!--l. 9--><p class="noindent" >
</p>
<h4 class="subsectionHead"><span class="titlemark">7.4.1   </span> <a 
 id="x9-890007.4.1"></a>File Headers</h4>
<!--l. 11--><p class="noindent" >Every ﬁle needs to have the license header.
</p><!--l. 13--><p class="noindent" >A Java example of the notices follows.
</p>
<!--l. 15-->
<div class="lstlisting" id="listing-65"><span class="label"><a 
 id="x9-89001r1"></a></span><span 
class="cmti-10">/</span><span 
class="tcti-1000">*</span> <br /><span class="label"><a 
 id="x9-89002r2"></a></span><span 
class="cmti-10"> </span><span 
class="tcti-1000">*</span><span 
class="cmti-10"> </span><span 
class="cmti-10"> </span><span 
class="cmti-10">This</span><span 
class="cmti-10"> </span><span 
class="cmti-10">file</span><span 
class="cmti-10"> </span><span 
class="cmti-10">is</span><span 
class="cmti-10"> </span><span 
class="cmti-10">part</span><span 
class="cmti-10"> </span><span 
class="cmti-10">of</span><span 
class="cmti-10"> </span><span 
class="cmti-10">the</span><span 
class="cmti-10"> </span><span 
class="cmti-10">Jikes</span><span 
class="cmti-10"> </span><span 
class="cmti-10">RVM</span><span 
class="cmti-10"> </span><span 
class="cmti-10">project</span><span 
class="cmti-10"> </span><span 
class="cmti-10">(</span><span 
class="cmti-10">http</span><span 
class="cmti-10">://</span><span 
class="cmti-10">jikesrvm</span><span 
class="cmti-10">.</span><span 
class="cmti-10">org</span><span 
class="cmti-10">)</span><span 
class="cmti-10">.</span> <br /><span class="label"><a 
 id="x9-89003r3"></a></span><span 
class="cmti-10"> </span><span 
class="tcti-1000">*</span> <br /><span class="label"><a 
 id="x9-89004r4"></a></span><span 
class="cmti-10"> </span><span 
class="tcti-1000">*</span><span 
class="cmti-10"> </span><span 
class="cmti-10"> </span><span 
class="cmti-10">This</span><span 
class="cmti-10"> </span><span 
class="cmti-10">file</span><span 
class="cmti-10"> </span><span 
class="cmti-10">is</span><span 
class="cmti-10"> </span><span 
class="cmti-10">licensed</span><span 
class="cmti-10"> </span><span 
class="cmti-10">to</span><span 
class="cmti-10"> </span><span 
class="cmti-10">You</span><span 
class="cmti-10"> </span><span 
class="cmti-10">under</span><span 
class="cmti-10"> </span><span 
class="cmti-10">the</span><span 
class="cmti-10"> </span><span 
class="cmti-10">Eclipse</span><span 
class="cmti-10"> </span><span 
class="cmti-10">Public</span><span 
class="cmti-10"> </span><span 
class="cmti-10">License</span><span 
class="cmti-10"> </span><span 
class="cmti-10">(</span><span 
class="cmti-10">EPL</span><span 
class="cmti-10">)</span><span 
class="cmti-10">;</span> <br /><span class="label"><a 
 id="x9-89005r5"></a></span><span 
class="cmti-10"> </span><span 
class="tcti-1000">*</span><span 
class="cmti-10"> </span><span 
class="cmti-10"> </span><span 
class="cmti-10">You</span><span 
class="cmti-10"> </span><span 
class="cmti-10">may</span><span 
class="cmti-10"> </span><span 
class="cmti-10">not</span><span 
class="cmti-10"> </span><span 
class="cmti-10">use</span><span 
class="cmti-10"> </span><span 
class="cmti-10">this</span><span 
class="cmti-10"> </span><span 
class="cmti-10">file</span><span 
class="cmti-10"> </span><span 
class="cmti-10">except</span><span 
class="cmti-10"> </span><span 
class="cmti-10">in</span><span 
class="cmti-10"> </span><span 
class="cmti-10">compliance</span><span 
class="cmti-10"> </span><span 
class="cmti-10">with</span><span 
class="cmti-10"> </span><span 
class="cmti-10">the</span><span 
class="cmti-10"> </span><span 
class="cmti-10">License</span><span 
class="cmti-10">.</span><span 
class="cmti-10"> </span><span 
class="cmti-10">You</span> <br /><span class="label"><a 
 id="x9-89006r6"></a></span><span 
class="cmti-10"> </span><span 
class="tcti-1000">*</span><span 
class="cmti-10"> </span><span 
class="cmti-10"> </span><span 
class="cmti-10">may</span><span 
class="cmti-10"> </span><span 
class="cmti-10">obtain</span><span 
class="cmti-10"> </span><span 
class="cmti-10">a</span><span 
class="cmti-10"> </span><span 
class="cmti-10">copy</span><span 
class="cmti-10"> </span><span 
class="cmti-10">of</span><span 
class="cmti-10"> </span><span 
class="cmti-10">the</span><span 
class="cmti-10"> </span><span 
class="cmti-10">License</span><span 
class="cmti-10"> </span><span 
class="cmti-10">at</span> <br /><span class="label"><a 
 id="x9-89007r7"></a></span><span 
class="cmti-10"> </span><span 
class="tcti-1000">*</span> <br /><span class="label"><a 
 id="x9-89008r8"></a></span><span 
class="cmti-10"> </span><span 
class="tcti-1000">*</span><span 
class="cmti-10"> </span><span 
class="cmti-10"> </span><span 
class="cmti-10"> </span><span 
class="cmti-10"> </span><span 
class="cmti-10"> </span><span 
class="cmti-10"> </span><span 
class="cmti-10">http</span><span 
class="cmti-10">://</span><span 
class="cmti-10">www</span><span 
class="cmti-10">.</span><span 
class="cmti-10">opensource</span><span 
class="cmti-10">.</span><span 
class="cmti-10">org</span><span 
class="cmti-10">/</span><span 
class="cmti-10">licenses</span><span 
class="cmti-10">/</span><span 
class="cmti-10">eclipse</span><span 
class="cmti-10">-1.0.</span><span 
class="cmti-10">php</span> <br /><span class="label"><a 
 id="x9-89009r9"></a></span><span 
class="cmti-10"> </span><span 
class="tcti-1000">*</span> <br /><span class="label"><a 
 id="x9-89010r10"></a></span><span 
class="cmti-10"> </span><span 
class="tcti-1000">*</span><span 
class="cmti-10"> </span><span 
class="cmti-10"> </span><span 
class="cmti-10">See</span><span 
class="cmti-10"> </span><span 
class="cmti-10">the</span><span 
class="cmti-10"> </span><span 
class="cmti-10">COPYRIGHT</span><span 
class="cmti-10">.</span><span 
class="cmti-10">txt</span><span 
class="cmti-10"> </span><span 
class="cmti-10">file</span><span 
class="cmti-10"> </span><span 
class="cmti-10">distributed</span><span 
class="cmti-10"> </span><span 
class="cmti-10">with</span><span 
class="cmti-10"> </span><span 
class="cmti-10">this</span><span 
class="cmti-10"> </span><span 
class="cmti-10">work</span><span 
class="cmti-10"> </span><span 
class="cmti-10">for</span><span 
class="cmti-10"> </span><span 
class="cmti-10">information</span> <br /><span class="label"><a 
 id="x9-89011r11"></a></span><span 
class="cmti-10"> </span><span 
class="tcti-1000">*</span><span 
class="cmti-10"> </span><span 
class="cmti-10"> </span><span 
class="cmti-10">regarding</span><span 
class="cmti-10"> </span><span 
class="cmti-10">copyright</span><span 
class="cmti-10"> </span><span 
class="cmti-10">ownership</span><span 
class="cmti-10">.</span> <br /><span class="label"><a 
 id="x9-89012r12"></a></span><span 
class="cmti-10"> </span><span 
class="tcti-1000">*</span><span 
class="cmti-10">/</span> <br /><span class="label"><a 
 id="x9-89013r13"></a></span><span 
class="cmbx-10">package</span> org.jikesrvm; <br /><span class="label"><a 
 id="x9-89014r14"></a></span> <br /><span class="label"><a 
 id="x9-89015r15"></a></span><span 
class="cmbx-10">import</span> org.jikesrvm.classloader.ClassLoader; <span 
class="cmti-10">//</span><span 
class="cmti-10"> </span><span 
class="cmti-10">FILL</span><span 
class="cmti-10"> </span><span 
class="cmti-10">ME</span><span 
class="cmti-10"> </span><span 
class="cmti-10">IN</span> <br /><span class="label"><a 
 id="x9-89016r16"></a></span> <br /><span class="label"><a 
 id="x9-89017r17"></a></span><span 
class="cmti-10">/</span><span 
class="tcti-1000">*</span><span 
class="tcti-1000">*</span> <br /><span class="label"><a 
 id="x9-89018r18"></a></span><span 
class="cmti-10"> </span><span 
class="tcti-1000">*</span><span 
class="cmti-10"> </span><span 
class="cmti-10">TODO</span><span 
class="cmti-10"> </span><span 
class="cmti-10">Substitute</span><span 
class="cmti-10"> </span><span 
class="cmti-10">a</span><span 
class="cmti-10"> </span><span 
class="cmti-10">brief</span><span 
class="cmti-10"> </span><span 
class="cmti-10">description</span><span 
class="cmti-10"> </span><span 
class="cmti-10">of</span><span 
class="cmti-10"> </span><span 
class="cmti-10">what</span><span 
class="cmti-10"> </span><span 
class="cmti-10">this</span><span 
class="cmti-10"> </span><span 
class="cmti-10">program</span><span 
class="cmti-10"> </span><span 
class="cmti-10">or</span><span 
class="cmti-10"> </span><span 
class="cmti-10">library</span><span 
class="cmti-10"> </span><span 
class="cmti-10">does</span><span 
class="cmti-10">.</span> <br /><span class="label"><a 
 id="x9-89019r19"></a></span><span 
class="cmti-10"> </span><span 
class="tcti-1000">*</span><span 
class="cmti-10">/</span>
</div>
<!--l. 39--><p class="noindent" >
</p>
<h4 class="subsectionHead"><span class="titlemark">7.4.2   </span> <a 
 id="x9-900007.4.2"></a>Coding style description</h4>
<!--l. 41--><p class="noindent" >The Jikes<sup class="textsuperscript"><span 
class="cmr-9">TM</span></sup> RVM coding style guidelines are similar to the Sun® Microsystems
”Code Conventions for the Java<sup class="textsuperscript"><span 
class="cmr-9">TM</span></sup> Programming Language”, with a few exceptions
listed below. Most of the style guide is intuitive; however, please read through the
document (or at least look at its sample code).
</p><!--l. 43--><p class="noindent" >We have adopted four modiﬁcations to the Sun code conventions:
</p>
                                                                  

                                                                  
     <ul class="itemize1">
     <li class="itemize"><span 
class="cmbx-10">Two-space  indenting  </span>The  Sun  coding  convention  suggests  4  space
     indenting; however with 80-column lines and four-space indenting, there is
     very little room left for code. Thus, we recommend using 2 space indenting.
     There are to be no tabs in the source ﬁles or trailing white space on any
     line.
     </li>
     <li class="itemize"><span 
class="cmbx-10">132 column lines in exceptional cases </span>The Sun coding convention is
     that lines be no longer than 80 columns. Several Jikes RVM contributors
     have found this constraining. Therefore, we allow 132 column lines for
     exceptional cases, such as to avoid bad line breaks.
     </li>
     <li class="itemize"><span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">if (VM.VerifyAssertions)</span></span></span> As a special case, the condition <span 
class="cmtt-10">if </span><br 
class="newline" /><span 
class="cmtt-10">(VM.VerifyAssertions) </span>is  usually  immediately  followed  by  the  call
     to  <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">VM._assert()</span></span></span>,  with  a  single  space  substituting  for  the  normal
     newline-and-indentation. See the <a 
href="#x9-830007.3">coding conventions</a> for an example.
     </li>
     <li class="itemize"><span 
class="cmbx-10">Capitalized ﬁelds </span>Under the Sun coding conventions, and as speciﬁed
     in The Java Language Speciﬁcation, Second Edition, the names of ﬁelds
     begin with a lowercase letter. (The only exception they give is for some
     ﬁnal static constants, which have names <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">ALL_IN_CAPITAL_LETTERS</span></span></span>, with
     underscores      separating      them.)      That      convention      reserves
     IdentiﬁersBeginningWithACapitalLetterFollowedByMixedCase   for   the
     names of classes and interfaces. However, most of the ﬁnal ﬁelds in the
     Conﬁguration class and the Properties interface also are in that format.
     Since the VM class inherits ﬁelds from both Properties and Conﬁguration,
     that&#x2019;s how we get VM.VerifyAssertions, etc.</li></ul>
<!--l. 54--><p class="noindent" >
</p>
<h4 class="subsectionHead"><span class="titlemark">7.4.3   </span> <a 
 id="x9-910007.4.3"></a>Javadoc requirements</h4>
<!--l. 56--><p class="noindent" >All non-trivial ﬁles should contain descriptive comments in <a 
href="http://www.oracle.com/technetwork/java/javase/documentation/index-jsp-135444.html" >Javadoc<sup class="textsuperscript"><span 
class="cmr-9">TM</span></sup></a> form so that
documentation can be generated automatically. Of course, additional non-Javadoc
source code comments should appear as appropriate.
     </p><ol  class="enumerate1" >
     <li 
  class="enumerate" id="x9-91002x1">Classes, methods and ﬁelds should have a block comment describing them
     if it makes sense. There is no need to add comments merely for the sake
     of commenting. For example, it is not necessary to add a comment for
     a method if the comment does not provide more information than the
     signature and the method name already do.
     </li>
     <li 
  class="enumerate" id="x9-91004x2">JavaDoc  comments  must  not  be  copied  from  methods  that  are  being
     overriden. If the comment from the method that you are overriding is
     suﬃcient, you do not need to provide JavaDoc for the newly added method
     - JavaDoc will automatically copy the JavaDoc from the overriden method.
                                                                  

                                                                  
     If you want to extend the comment from the overriden method with new
     information, use @inheritDoc to copy the comment from the superclass
     and add your text.
     </li>
     <li 
  class="enumerate" id="x9-91006x3">JavaDoc for methods contains a short description of their arguments (using
     <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">@param</span></span></span>), the return value (using <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">@return</span></span></span>) and the exceptions they may
     throw (using <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">@throws</span></span></span>).
     </li>
     <li 
  class="enumerate" id="x9-91008x4">Each class should include <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">@see</span></span></span> and <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">@link</span></span></span> references as appropriate.</li></ol>
<!--l. 2--><p class="noindent" >
</p>
<h3 class="sectionHead"><span class="titlemark">7.5   </span> <a 
 id="x9-920007.5"></a>Compiler DNA</h3>
<!--l. 5--><p class="noindent" >The Jikes RVM adaptive system uses the compiler DNA found in <br 
class="newline" /><span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">org.jikesrvm.adaptive.recompilation.CompilerDNA</span></span></span>. The important values in
here are the <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">compilationRates</span></span></span> and the <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">speedupRates</span></span></span>. If you modify Jikes
RVM then it&#x2019;s likely you need to recalibrate the adaptive system for your
changes.
</p><!--l. 7--><p class="noindent" >In Jikes RVM 3.1.3 or earlier, do the following:
</p><!--l. 9--><p class="noindent" >
     </p><ol  class="enumerate1" >
     <li 
  class="enumerate" id="x9-92002x1">run     the     compiler-dna     test     harness     (”ant     -f     test.xml
     -Dtest-run.name=compiler-dna”).  This  will  automatically  compile  and
     run Jikes RVM on SPEC JVM &#x2019;98. You will want to conﬁgure the ant
     property external.lib.dir to be a directory containing your SPEC JVM &#x2019;98
     directory. Your SPEC JVM &#x2019;98 directory must be named ”SPECjvm98”.
     </li>
     <li 
  class="enumerate" id="x9-92004x2">load the xml ﬁle <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">results/tests/compiler-dna/Report.xml</span></span></span> into either
     an XML viewer (such as a web browser) or into a text editor
     </li>
     <li 
  class="enumerate" id="x9-92006x3">ﬁnd  the  section  named  <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">Measure_Compilation_Base</span></span></span>,  then  look  within
     this section for statistics and ﬁnd the static Base.bcb/ms. For example,
     <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">&#x003C;statistic key=&#x0022;Base.bcb/ms&#x0022; value=&#x0022;1069.66&#x0022;/&#x003E;</span></span></span>. In the <br 
class="newline" /><span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">compilationRates</span></span></span> array this will be the value of element 0, it corresponds
     to how many bytecodes the baseline compiler can compile per millisecond.
     </li>
     <li 
  class="enumerate" id="x9-92008x4">ﬁnd the section named <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">Measure_Compilation_Opt_0</span></span></span> and the statistic
     Opt.bcb/ms. This is element 1 in the <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">compilationRates</span></span></span> array.
     </li>
     <li 
  class="enumerate" id="x9-92010x5">ﬁnd the section named <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">Measure_Compilation_Opt_1</span></span></span> and the statistic
     Opt.bcb/ms. This is element 2 in the <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">compilationRates</span></span></span> array.
                                                                  

                                                                  
     </li>
     <li 
  class="enumerate" id="x9-92012x6">ﬁnd the section named <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">Measure_Compilation_Opt_2</span></span></span> and the statistic
     Opt.bcb/ms. This is element 3 in the <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">compilationRates</span></span></span> array.
     </li>
     <li 
  class="enumerate" id="x9-92014x7">ﬁnd  the  section  named  <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">Measure_Performance_Base</span></span></span> and  the  statistic
     named  <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">aggregate.best.score</span></span></span> and  record  its  value.  For  example,
     for  <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">&#x003C;statistic key=&#x0022;aggregate.best.score&#x0022; value=&#x0022;28.90&#x0022;/&#x003E;</span></span></span> you
     would record 28.90.
     </li>
     <li 
  class="enumerate" id="x9-92016x8">ﬁnd the section named <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">Measure_Performance_Opt_0</span></span></span> and the statistic
     <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">named aggregate.best.score</span></span></span>.  Divide  this  value  by  the  value  you
     recorded in step 7, this is the value for element 1 in the <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">speedupRates</span></span></span>
     array.   For   example,   for   <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">&#x003C;statistic key=&#x0022;aggregate.best.score&#x0022;</span>
     <span 
class="cmtt-10">value=&#x0022;137.50&#x0022;/&#x003E;</span></span></span> the <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">speedupRates</span></span></span> array element 1 should have a value
     of 4.76.
     </li>
     <li 
  class="enumerate" id="x9-92018x9">ﬁnd the section named <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">Measure_Performance_Opt_1</span></span></span> and the statistic
     named <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">aggregate.best.score</span></span></span>. As with stage 8 divide this value by the
     value recorded in step 7, this is the value for element 2 in the <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">speedupRates</span></span></span>
     array.
     </li>
     <li 
  class="enumerate" id="x9-92020x10">ﬁnd the section named <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">Measure_Performance_Opt_2</span></span></span> and the statistic
     named <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">aggregate.best.score</span></span></span>. As with stage 8 divide this value by the
     value recorded in step 7, this is the value for element 3 in the <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">speedupRates</span></span></span>
     array.</li></ol>
<!--l. 22--><p class="noindent" >In Jikes RVM 3.1.4 or later, the directory for the test results (e.g. <br 
class="newline" /><span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">results/tests/compiler-dna/</span></span></span>) should contain a ﬁle <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">CompilerDNA.xml</span></span></span>.
Copy the contents into <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">CompilerDNA</span></span></span> and modify them so that the code
compiles.
</p><!--l. 24--><p class="noindent" >You should then save <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">CompilerDNA</span></span></span> and recompile a production RVM which will use
these values.
</p><!--l. 26--><p class="noindent" >If you are frequently changing the compiler dna, you may want to use the command
line option <span class="obeylines-h"><span class="verb"><span 
class="cmtt-10">-X:aos:dna=&#x003C;file name&#x003E;</span></span></span> to dynamically load compiler dna data without
having to rebuild Jikes RVM.
</p><!--l. 2--><p class="noindent" >
</p>
<h3 class="sectionHead"><span class="titlemark">7.6   </span> <a 
 id="x9-930007.6"></a>Editing Jikes RVM in an IDE</h3>
<!--l. 5--><p class="noindent" >One goal of the JikesRVM project over recent years has been the ability to
develop Jikes RVM in a development environment such as Eclipse. This has
been possible for the MMTk component since 2005, and as of early 2007
(release 2.9.0) it is possible to work with the majority of the Jikes RVM
codebase in Eclipse and similar environments. With Jikes RVM release 2.9.1,
setting up your Eclipse environment to work with Jikes RVM became even
easier.
                                                                  

                                                                  
</p><!--l. 7--><p class="noindent" >
</p>
<h4 class="subsectionHead"><span class="titlemark">7.6.1   </span> <a 
 id="x9-940007.6.1"></a>Editing JikesRVM in Eclipse</h4>
<!--l. 9--><p class="noindent" >These instructions assume you are working with Jikes RVM version 2.9.1 or
later.
</p><!--l. 11--><p class="noindent" >
     </p><ol  class="enumerate1" >
     <li 
  class="enumerate" id="x9-94002x1">Create a JikesRVM source tree either via Git checkout or unpacking a
     distribution. <!--l. 13-->
     <div class="lstlisting" id="listing-66"><span class="label"><a 
 id="x9-94003r1"></a></span><span 
class="tcrm-1000">$</span> git clone https://github.com/JikesRVM/JikesRVM.git
     
     </div>
     </li>
     <li 
  class="enumerate" id="x9-94005x2">Create the machine-generated ﬁles and eclipse metadata:
     </li>
     <li 
  class="enumerate" id="x9-94007x3">If you have a recent version of Jikes RVM (3.0 onwards): <!--l. 18-->
     <div class="lstlisting" id="listing-67"><span class="label"><a 
 id="x9-94008r1"></a></span><span 
class="tcrm-1000">$</span> cd jikesrvm <br /><span class="label"><a 
 id="x9-94009r2"></a></span><span 
class="tcrm-1000">$</span> bin/buildit --eclipse localhost
     
     </div>
     <!--l. 22--><p class="noindent" ><span 
class="cmti-10">Note that if you will not or cannot build on your local machine</span>, substitute
     localhost for the name of a host you can build on (buildit will perform the build
     remotely and then copy the requisite ﬁles back).
     </p></li>
     <li 
  class="enumerate" id="x9-94011x4">If you are working on an older version (2.9.1 - 2.9.3), you can follow this
     procedure: <!--l. 25-->
     <div class="lstlisting" id="listing-68"><span class="label"><a 
 id="x9-94012r1"></a></span><span 
class="tcrm-1000">$</span> cd jikesrvm <br /><span class="label"><a 
 id="x9-94013r2"></a></span><span 
class="tcrm-1000">$</span> ant -Dhost.name=ia32-linux -Dconfig.name=development <br /><span class="label"><a 
 id="x9-94014r3"></a></span><span 
class="tcrm-1000">$</span> ant -Dhost.name=ia32-linux -Dconfig.name=development eclipse-project
     
     </div>
     <!--l. 30--><p class="noindent" >If you will not or cannot build on your local machine:
         </p><ol  class="enumerate2" >
         <li 
  class="enumerate" id="x9-94016x1">copy your tree to build build host somehow
         </li>
         <li 
  class="enumerate" id="x9-94018x2">perform the above ant tasks
         </li>
         <li 
  class="enumerate" id="x9-94020x3">copy the following generated ﬁles and directories back to the machine you
         will edit on:
             <ul class="itemize1">
             <li class="itemize">jikesrvm/.project
                                                                  

                                                                  
             </li>
             <li class="itemize">jikesrvm/.classpath
             </li>
             <li class="itemize">jikesrvm/eclipse</li></ul>
         </li></ol>
     </li>
     <li 
  class="enumerate" id="x9-94022x5">Import the newly created Eclipse project into your Eclipse workspace.
         <ol  class="enumerate2" >
         <li 
  class="enumerate" id="x9-94024x1">From Eclipse, select File <span 
class="tcrm-1000">→</span> Import
         </li>
         <li 
  class="enumerate" id="x9-94026x2">Select ”Existing Projects Into Workspace” <hr class="figure" /><div class="figure" 
> <img 
src="images/EditingJikesRVMInAnIDE-ImportProject.jpg" alt="PIC"  
 />
         </div><hr class="endfigure" />
         </li>
         <li 
  class="enumerate" id="x9-94028x3">Browse to ﬁnd the top-level directory.
         </li>
         <li 
  class="enumerate" id="x9-94030x4">Select the project (in this case JikesRVM ia32-linux development) <hr class="figure" /><div class="figure" 
>
         <img 
src="images/EditingJikesRVMInAnIDE-SelectDirectory.jpg" alt="PIC"  
 />
         </div><hr class="endfigure" />
         </li>
         <li 
  class="enumerate" id="x9-94032x5">Hit Finish</li></ol>
     </li></ol>
<!--l. 61--><p class="noindent" >
</p>
<h4 class="subsectionHead"><span class="titlemark">7.6.2   </span> <a 
 id="x9-950007.6.2"></a>Setup for easier compliance with the Checkstyle rules</h4>
<!--l. 63--><p class="noindent" >If you consider <a 
href="http://www.jikesrvm.org/Contributions/" >contributing</a> changes back to Jikes RVM, it is helpful to conﬁgure
your IDE to comply with the Jikes RVM <a 
href="#x9-880007.4">coding style</a>. The coding style forbids the
use of tabs and requires that no line ends with whitespace.
</p><!--l. 65--><p class="noindent" >If you have a separate workspace for your work with Jikes RVM, you can set up
Eclipse for correct tab usage by conﬁguring the text editors. Go to Window
<span 
class="tcrm-1000">→</span> Preferences and then to General <span 
class="tcrm-1000">→</span> Editors <span 
class="tcrm-1000">→</span> Text editors (Eclipse 3.6) or
Window <span 
class="tcrm-1000">→</span> Preferences <span 
class="tcrm-1000">→</span> General <span 
class="tcrm-1000">→</span> Editors <span 
class="tcrm-1000">→</span> Text Editors (Eclipse 3.5 and
earlier). Check ”Insert spaces for tabs”. Make sure that ”Displayed tab width” is set
to 2. This setting aﬀects the non-Java editors (e.g. XML editor for the ant ﬁles for
the build).
</p><!--l. 67--><p class="noindent" >To set the tab width for Java code, you need to setup the Java code style. We
currently do not provide a style template, so you will have to deﬁne your own. Go to
the project properties (e.g. via Project <span 
class="tcrm-1000">→</span> Properties) and select Java Code Style
<span 
class="tcrm-1000">→</span> Formatter. Check the box ”Enable project speciﬁc settings” and create a new
proﬁle for Jikes RVM. Edit the new proﬁle. In the edit dialog, choose the tab
”Indentation”. Set the tab policy to ”Spaces only” and set both indentation size and
tab size to 2. Also make sure that the box ”Empty lines” at the bottom of the
”Indentation” tab is not checked.
                                                                  

                                                                  
</p><!--l. 69--><p class="noindent" >To ensure that you do not introduce whitespace at the end of lines you can conﬁgure
Eclipse&#x2019;s Save actions in the project properties at Java Editor <span 
class="tcrm-1000">→</span> Save Actions.
Check the box ”Enable project speciﬁc settings” and the box ”Perform the
selected actions on save” as well as ”Additional actions”. Press ”Conﬁgure”
and check the box ”Remove trailing whitespace” in the ”Code Organizing”
tab.
</p><!--l. 73--><p class="noindent" >
</p>
<h4 class="subsectionHead"><span class="titlemark">7.6.3   </span> <a 
 id="x9-960007.6.3"></a>Editing JikesRVM in NetBeans</h4>
<!--l. 75--><p class="noindent" >
     </p><ol  class="enumerate1" >
     <li 
  class="enumerate" id="x9-96002x1">Follow the instructions for Eclipse including building the eclipse project
     with ant
     </li>
     <li 
  class="enumerate" id="x9-96004x2">Install the Eclipse project importer
     </li>
     <li 
  class="enumerate" id="x9-96006x3">Select File <span 
class="tcrm-1000">→</span> Import Project <span 
class="tcrm-1000">→</span> Eclipse Project
         <ol  class="enumerate2" >
         <li 
  class="enumerate" id="x9-96008x1">Choose to import project ignoring project dependencies
         </li>
         <li 
  class="enumerate" id="x9-96010x2">Select the top-level directory you created with the JikesRVM in as
         the project to import
         </li>
         <li 
  class="enumerate" id="x9-96012x3">Select a new folder as the destination (workspace) for the import
         </li>
         <li 
  class="enumerate" id="x9-96014x4">Hit Finish</li></ol>
     </li></ol>
                                                                  

                                                                  
<!--l. 2--><div class="crosslinks"><p class="noindent"></p></div>
<!--l. 2--><p class="noindent" ><a 
 id="tailModifyingJikesRVM.html"></a></p> 
</body></html> 
